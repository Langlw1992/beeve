# Beeve — AI Agent Rules

## Response Language

**Always respond in Chinese (中文).** All explanations, comments in generated code, commit messages, and PR descriptions should be in Chinese.

## Core Principles

### Verify Before You Code

**Do NOT rely on training data or memory for any API usage, syntax, or design patterns.** Before writing code that involves any library, framework, or tool:

1. **Use Context7 first** to retrieve the latest documentation and best practices
2. **If Context7 yields no results**, fetch the official documentation from the web
3. **If still uncertain**, stop immediately and ask the user — do NOT guess or fabricate

This applies to all external dependencies including but not limited to: SolidJS, Zag.js, tailwind-variants, TanStack Router, Vitest, Storybook, Astro, and any npm package. **Fabricating APIs, inventing non-existent parameters, or hallucinating syntax is strictly prohibited.**

### Research Before You Design

**Every solution must be informed by mainstream implementations and community best practices.** When planning a feature, refactor, or architectural decision:

1. Research how well-known open-source projects and libraries solve the same problem
2. Reference established design patterns and conventions in the ecosystem
3. Justify your approach — if it deviates from the mainstream, explain why explicitly

**Do NOT invent solutions in isolation.** Closed-door engineering and self-reinforcing assumptions lead to fragile, non-idiomatic code. When in doubt, research first, then propose.

### Leverage Skills and MCP Tools

**Prioritize existing agent skills and MCP tools over writing custom solutions.** When facing a task:

1. Check if an installed skill or MCP tool already handles the task — use it directly
2. If no matching skill is found, use `find-skills` to search for an installable agent skill before building from scratch
3. Only implement custom logic when no suitable skill or MCP tool exists

### Verify UI Changes in Browser

**Every frontend visual change must be verified via browser MCP after modification.** Do not assume UI changes are correct based on code alone — take a screenshot or inspect the rendered page through the browser to confirm the result matches expectations.

### Do NOT Start or Stop Servers

**Server lifecycle is controlled by the user, not the agent.** You are strictly prohibited from starting, stopping, or restarting any dev server (`pnpm dev:web`, `pnpm dev:server`, etc.). If a server restart is required for your changes to take effect, prompt the user with a clear message explaining why a restart is needed.

### Format and Type-Check After Every Change

**After any code modification, always run formatting and type-checking before considering the task complete:**

1. **Format:** `pnpm format` (runs Biome formatter across the entire monorepo)
2. **Type-check:** `pnpm typecheck` (runs TypeScript type-checking across all packages via Turbo)

Fix any errors surfaced by these commands before proceeding. Do not leave formatting inconsistencies or type errors for the user to resolve.

## Project Overview

Beeve is a **SolidJS component library** built as a **pnpm monorepo** managed by **Turborepo**.

## Commands

```bash
# Root-level
pnpm install              # Install all dependencies
pnpm build                # Build all packages (turbo)
pnpm lint                 # Lint all packages (turbo)
pnpm lint:fix             # Auto-fix lint issues
pnpm format               # Format with Biome
pnpm typecheck            # Type-check all packages

# UI library (packages/ui)
pnpm --filter @beeve/ui test           # Run tests in watch mode
pnpm --filter @beeve/ui test:run       # Run tests once
pnpm --filter @beeve/ui test:coverage  # Run tests with coverage (80% threshold)

# Run a single test file
pnpm --filter @beeve/ui vitest run src/components/Button/Button.test.tsx

# Dev servers
pnpm dev:web              # Web app + docs + storybook
pnpm dev:server           # Server only
```

## Architecture

**Monorepo packages:**

- `packages/ui` — SolidJS component library (`@beeve/ui`), built with tsup
- `apps/web` — Demo/showcase app using Vite + TanStack Router v1 (file-based routing)
- `apps/storybook` — Storybook for component documentation
- `apps/ui-doc` — Astro Starlight documentation site

**UI library layering:**

```
src/primitives/   → Headless primitives (Zag.js state machines): types + hooks
src/components/   → Styled components (tailwind-variants): UI + composition
src/providers/    → Context providers (ThemeProvider)
src/themes/       → Theme presets (base colors + theme colors, oklch)
src/styles/       → Global CSS (Tailwind base + theme variables)
src/index.ts      → Public API re-exports
```

**Theming:** CSS custom properties (oklch color space) generated by `src/themes/`, managed at runtime by `ThemeProvider` context. Theme persists to localStorage under key `beeve-theme`. Supports light/dark/system modes. Base colors (neutral, zinc, stone, gray, slate) + theme colors (blue, green, pink, etc.).

**Routing (web app):** TanStack Router v1 with `createFileRoute()`. Files in `apps/web/src/routes/` auto-generate `routeTree.gen.ts`. The `__root.tsx` layout provides a persistent sidebar with theme controls.

## Key Conventions

### Component File Structure

Every component lives in its own directory under `packages/ui/src/components/`:

```
ComponentName/
├── ComponentName.tsx          # Implementation
├── ComponentName.test.tsx     # Vitest + @solidjs/testing-library
├── ComponentName.stories.tsx  # Storybook story
├── index.ts                   # Re-exports (named exports + types)
└── README.md                  # (optional) Component docs
```

After creating a component, add its export to `packages/ui/src/index.ts`.

### Styling

- Use `tv()` from `tailwind-variants` for all component variant definitions
- Tailwind CSS v4 via the `@tailwindcss/vite` plugin
- No utility class strings scattered in logic — keep them in `tv()` definitions
- Use `slots` in `tv()` for multi-element components (e.g., Switch, Badge)
- Theme colors via CSS custom properties: `bg-primary`, `text-foreground`, `border-border`, etc.
- Border radius: `rounded-[var(--radius)]` for theme-aware corners

### SolidJS Patterns

- **NEVER** destructure props — it breaks reactivity. Use `splitProps()` or access `props.xxx` directly
- Use `splitProps()` to separate component-specific props from pass-through HTML attributes
- Props use `type` keyword (not `interface`) — no `any` (enforced by Biome)
- Use `import type` for type-only imports (enforced by Biome: `useImportType`)
- Component type: `Component<Props>` from `solid-js`
- JSX children type: `JSX.Element` from `solid-js`
- Reactivity: use `createSignal`, `createMemo`, `createEffect`
- Conditional rendering: `Show`, `For`, `Switch/Match`
- Overlay elements: `Portal` from `solid-js/web`
- Icons: `lucide-solid` (not lucide-react)

### Zag.js Integration

Complex interactive components (Dialog, Select, Popover, Menu, Slider, Tooltip, etc.) use **Zag.js state machines**:

- Primitives in `src/primitives/{name}/`: `types.ts` (props interface) + `use-{name}.ts` (hook wrapping `useMachine` + `normalizeProps`)
- Components in `src/components/{Name}/`: import primitive hook, add styling with `tv()`, compose JSX
- Pattern: `useMachine(machine, () => ({...options}))` → `connect(service, normalizeProps)` → spread API props onto elements

### Formatting (Biome)

- 2-space indent, single quotes, no semicolons (asNeeded), trailing commas, no bracket spacing
- `useImportType: error` — always use `import type` for type-only imports
- `noExplicitAny: error` — no `any` type allowed
- `noUnusedImports: error`, `noUnusedVariables: error`
- Files matching `*.gen.ts` are excluded from linting

### TypeScript Code Style

- **Use `type` instead of `interface`** for all type definitions. Use `type Props = { ... }` not `interface Props { ... }`
- **No `any`** — use precise types. If the type is truly unknown, use `unknown` and narrow it with type guards
- **Minimize `as` type assertions** — prefer type inference, generics, or type guards. Only use `as` when there is no other option and add a comment explaining why
- **No ignore annotations** — `@ts-ignore`, `@ts-expect-error`, `// biome-ignore`, `eslint-disable`, and any other suppression comments are strictly prohibited. Fix the underlying issue instead
- **Use types from type libraries** — if a dependency provides its own type definitions (e.g., `@zag-js/*`, `solid-js`, `@tanstack/solid-router`), import and use those types directly instead of redefining them
- **No duplicate type definitions** — define each type once in a single location and import it wherever needed. If a type is shared across modules, place it in a dedicated `types.ts` file

### Turbo Pipeline

- `transit` task is a pre-build step that ensures generated files are up-to-date
- `lint` and `typecheck` tasks depend on `transit`
- `build` tasks depend on `^build` (build dependencies first)

### Testing

- **Stack:** Vitest + @solidjs/testing-library + jsdom
- **Coverage threshold:** 80% (lines, functions, branches, statements)
- **Setup file:** `packages/ui/src/test/setup.ts` (mocks ResizeObserver, matchMedia, scrollIntoView)
- **Zag.js limitation:** Zag.js state machines don't work correctly in jsdom — mark those tests with `it.skip` and note "需要 e2e 测试"
- **Test style:** Chinese test descriptions, grouped by `describe` blocks (渲染, 变体, 交互, etc.)
- **Render pattern:** Always wrap in arrow function: `render(() => <Component />)`

### Code Comments

- Use Chinese for code comments and JSDoc descriptions
- Component file header: `/** @beeve/ui - ComponentName Component */` followed by Chinese description
- Section separators: `// ==================== 样式定义 ====================`

### Import Conventions

- Use `import type` for type-only imports: `import type {Component, JSX} from 'solid-js'`
- Mixed imports: `import {splitProps, Show, type Component, type JSX} from 'solid-js'`
- Internal imports use relative paths within `packages/ui/src/`
- Cross-package imports use package name: `import {Button} from '@beeve/ui'`

### Package Manager

- Always use `pnpm` (not npm or yarn)
- Filter commands: `pnpm --filter @beeve/ui <command>`
- Never manually edit `pnpm-lock.yaml`

